<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title></title>
    <link rel="stylesheet" href="css/jquery.mobile-1.4.5.min.css" />
    <link rel="stylesheet" href="css/jtsage-datebox.min.css" />
    <link rel="stylesheet" href="css/custom.css" />
    <script src="js/jquery-1.11.3.min.js"></script>
    <script src="js/jquery.mobile-1.4.5.min.js"></script>
    <script src="js/jtsage-datebox.min.js"></script>
    <script id="entry-template" type="text/x-handlebars-template">
        <div data-role="collapsibleset" 
             data-theme="a" 
             data-content-theme="a">
            <div data-role="collapsible">
                <h2>Alarms Setup</h2>
                <div data-role="collapsibleset" 
                     data-theme="a" 
                     data-content-theme="a">
                    {{#each alarms}}
                    <div data-role="collapsible">
                        <h3>Alarm #{{math @index "+" 1}}</h3>
                        <div class="ui-field-contain">
                            <label for="alarm_{{@index}}_title">Title:</label>
                            <input type="text" 
                                   name="alarm_{{@index}}_title" 
                                   id="alarm_{{@index}}_title" 
                                   value="{{title}}" />
                        </div>
                        <div class="ui-field-contain">
                            <label for="alarm_{{@index}}_time">Time:</label>
                            <input type="date" 
                                   data-role="datebox" 
                                   name="alarm_{{@index}}_time" 
                                   id="alarm_{{@index}}_time" 
                                   data-options='{"mode": "timebox"}' />
                        </div>
                        <fieldset>
                            <div data-role="fieldcontain">
                                <label for="alarm_{{@index}}_repeat">Repeat?</label>
                                <input type="checkbox" id="alarm_{{@index}}_repeat" data-role="flipswitch">
                            </div>
                        </fieldset>
                        <fieldset data-role="controlgroup" 
                                  data-type="horizontal" 
                                  class="ui-field-contain">
                            <legend>Days</legend>
                            <input type="checkbox" 
                                   name="alarm_{{@index}}_days" 
                                   id="alarm_{{@index}}_days_mon" 
                                   value="mon" />
                            <label for="alarm_{{@index}}_days_mon">Mon</label>

                            <input type="checkbox" 
                                   name="alarm_{{@index}}_days" 
                                   id="alarm_{{@index}}_days_tue" 
                                   value="tue" />
                            <label for="alarm_{{@index}}_days_tue">Tue</label>

                            <input type="checkbox" 
                                   name="alarm_{{@index}}_days" 
                                   id="alarm_{{@index}}_days_wed" 
                                   value="wed" />
                            <label for="alarm_{{@index}}_days_wed">Wed</label>

                            <input type="checkbox" 
                                   name="alarm_{{@index}}_days" 
                                   id="alarm_{{@index}}_days_thu" 
                                   value="thu" />
                            <label for="alarm_{{@index}}_days_thu">Thu</label>

                            <input type="checkbox" 
                                   name="alarm_{{@index}}_days" 
                                   id="alarm_{{@index}}_days_fri" 
                                   value="fri" />
                            <label for="alarm_{{@index}}_days_fri">Fri</label>

                            <input type="checkbox" 
                                   name="alarm_{{@index}}_days" 
                                   id="alarm_{{@index}}_days_sat" 
                                   value="sat" />
                            <label for="alarm_{{@index}}_days_sat">Sat</label>

                            <input type="checkbox" 
                                   name="alarm_{{@index}}_days" 
                                   id="alarm_{{@index}}_days_sun" 
                                   value="sun" />
                            <label for="alarm_{{@index}}_days_sun">Sun</label>
                        </fieldset>
                    </div>
                    {{/each}}
                </div>
            </div>
            <div data-role="collapsible">
                <h2>Internet Radio</h2>

                <div class="ui-field-contain">
                    <label for="radio_stations_country">Radio Stations country</label>
                    <select name="radio_stations_country"
                            id="radio_stations_country"
                            type="text" 
                            value="{{radio/country}}">
                        {{#select radio/country}}
                        {{#each radio/countries}}
                        <option value="{{country_code}}">{{name}} ({{country_code}})</option>
                        {{/each}}
                        {{/select}}
                    </select>
                </div>
                <div class="ui-field-contain">
                    <label for="dirble_api_key">Dirble API Key</label>
                    <input name="dirble_api_key"
                           id="dirble_api_key"
                           type="text" />
                </div>
                <div class="ui-field-contain">
                    <label for="radio_custom_stations">Custom Stations (Stream URI)</label>
                    <textarea name="radio_custom_stations"
                              id="radio_custom_stations"
                              style="font-family: monospace; overflow: scroll; white-space: pre;"
                              placeholder="Stream URIs (one on each line)"
                              rows="{{math radio/custom_stations.length '+' 2}}">
{{#each radio/custom_stations}}
{{stream_uri}}
{{/each}}</textarea>
                </div>
            </div>
            <div data-role="collapsible">
                <h2>General</h2>
                <div class="ui-field-contain">
                    <label for="general_config_file">Config file</label>
                    <input name="general_config_file"
                           id="general_mplayer_path"
                           type="text" 
                           value="{{general/config_file}}" />
                </div>
                <div class="ui-field-contain">
                    <label for="general_mplayer_path">MPlayer path</label>
                    <input name="general_mplayer_path"
                           id="general_mplayer_path"
                           type="text" 
                           value="{{general/mplayer_path}}" />
                </div>
            </div>
        </div>
        <button type="submit" value="Submit">Submit</button>
</script>
    <script type="text/javascript" src="js/handlebars-v4.0.2.js"></script>
    <script>
        Handlebars.registerHelper("math", function (lvalue, operator, rvalue, options) {
            lvalue = parseFloat(lvalue);
            rvalue = parseFloat(rvalue);

            return {
                "+": lvalue + rvalue,
                "-": lvalue - rvalue,
                "*": lvalue * rvalue,
                "/": lvalue / rvalue,
                "%": lvalue % rvalue
            }[operator];
        });

        window.Handlebars.registerHelper('select', function (value, options) {
            var $el = $('<select />').html(options.fn(this));
            $el.find('[value="' + value + '"]').attr({ 'selected': 'selected' });
            return $el.html();
        });

        function pad(num, size) { return ('000000000' + num).substr(-size); }
    </script>
</head>
<body>
    <div data-role="page">
        <div data-role="header">
            <h1>Digital Nightstand Frontend</h1>
            <div data-role="navbar" 
                 data-grid="a">
                <ul>
                    <li>
                        <a href="index.html"
                           class="ui-btn ui-btn-active ui-state-persist ui-icon-prev">Setup</a>
                    </li>
                    <li>
                        <a href="player.html" 
                           class="ui-btn ui-icon-prev" 
                           data-ajax="false">Radio Player</a>
                    </li>
                </ul>
            </div><!-- /navbar -->
        </div><!-- /header -->

        <div role="main" 
             class="ui-content">
            <form method="post" 
                  id="form">

            </form>
        </div><!-- /content -->
    </div><!-- /page -->
    <script>
        $(document).ready(function () {
            $.when($.getJSON("/api/config"), $.getJSON("/api/list_countries")).done(function (data, countries) {
                console.log(data);
                console.log(countries);
                var context = data[0] || {
                    alarms: [{
                        // #1
                    }, {
                        // #2
                    }, {
                        // #3
                    }, {
                        // #4
                    }, {
                        // #5
                    }],
                    radio: {
                        country: "NO",
                        radio_stations: []
                    },
                    general: {
                        config_file: "config.json",
                        mplayer_path: "mplayer"
                    }
                };
                context.radio.countries = countries[0] || [{
                    country_code: "GB",
                    name: "United Kingdom"
                }, {
                    country_code: "NO",
                    name: "Norway"
                }];
                var alarms_length = context.alarms.length; // Configured alarms
                if (context.alarms.length < 5) {
                    // If the number of current configured alarms is less than 5, 
                    // append extra, un-configured, alarms so that the number of 
                    // alarms is a total of 5
                    for (var i = context.alarms.length; i < 5; i++) {
                        context.alarms.push([]);
                    }
                }
                var num_alarms = context.alarms.length; // All alarms
                var source = $("#entry-template").html();
                var template = Handlebars.compile(source);
                var html = template(context);
                $("#form").html(html);

                // Only loop through configured alarms
                for (var i = 0; i < alarms_length; i++) {
                    var alarm = context.alarms[i];
                    var $time = $("#alarm_" + i + "_time");
                    var $repeat = $("#alarm_" + i + "_repeat");
                    $time.val(pad(alarm.time[0], 2) + ":" + pad(alarm.time[1], 2));
                    if (!!alarm.repeat) {
                        $repeat.attr("checked", "checked").trigger("change");
                    }
                    if (alarm.days && alarm.days.length > 0) {
                        $("input[name='alarm_" + i + "_days']").each(function (index, elem) {
                            var $this = $(this);
                            if ($.inArray($this.val(), alarm.days) > -1) {
                                $this.attr("checked", "checked").trigger("change");
                            }
                        });
                    }
                }
                $("#form").trigger("create");
                $("#dirble_api_key").on("change", function (e) {
                    var $this = $(this);
                    var val = $this.val();
                    if (val && val.length > 0) {
                        // Send and save the key to the main application
                        $.post("/dirble_api_key", JSON.stringify({
                            // Base64 encode the key before sending it
                            dirble_api_key: btoa(val) 
                        })).done(function () {
                            // Clear the field to prevent reading of the API key
                            $this.val("");
                        });
                    }
                });
                $("#form").on("submit", function (e) {
                    e.preventDefault();
                    var alarms = [];
                    for (var i = 0; i < num_alarms; i++) {
                        var $time = $("#alarm_" + i + "_time");
                        var $hour = $("#alarm_" + i + "_hour");
                        var $min = $("#alarm_" + i + "_min");
                        var $title = $("#alarm_" + i + "_title");
                        var $days = $("input[name='alarm_" + i + "_days']:checked");
                        var $repeat = $("#alarm_" + i + "_repeat:checked");

                        if ($time.val()) {
                            var time = $time.val().split(":");
                            var hour = parseInt(time[0], 10);
                            var min = parseInt(time[1], 10);
                            var obj = {
                                repeat: !!$repeat.length,
                                time: [hour, min],
                                //time: [+$hour.val(), +$min.val()],
                                title: $title.val() || "ALARM",
                            };
                            if ($days.length > 0) {
                                obj.days = [];
                                $days.each(function (index) {
                                    obj.days[index] = $(this).val();
                                });
                            }
                            alarms.push(obj);
                        }
                    }

                    console.log(alarms);
                    var radio = {
                        country: $("#radio_stations_country").val(),
                        radio_stations: []
                    };
                    var radio_custom_stations = $("#radio_custom_stations").val().trim().split("\n");
                    if (radio_custom_stations.length > 0) {
                        radio_custom_stations = radio_custom_stations.map(function (line, index) {
                            return {
                                name: "Custom #" + (index + 1),
                                groups: ["Custom"],
                                stream_uri: line + ""
                            };
                        });
                    } else {
                        radio_custom_stations = [];
                    }
                    radio.radio_stations.concat(radio_custom_stations);

                    $.post("/", JSON.stringify({
                        alarms: alarms,
                        radio: radio
                        //radio_stations: radio_custom_stations
                    }));

                });
            });
        });
    </script>
</body>
</html>