<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title></title>
    <link rel="stylesheet" href="css/jquery.mobile-1.4.5.min.css" />
    <link rel="stylesheet" href="css/jtsage-datebox.min.css" />
    <link rel="stylesheet" href="css/custom.css" />
    <script src="js/jquery-1.11.3.min.js"></script>
    <script src="js/jquery.mobile-1.4.5.min.js"></script>
    <script src="js/jtsage-datebox.min.js"></script>
    <script id="entry-template" type="text/x-handlebars-template">
        <h2>Alarms Setup</h2>
        <div data-role="collapsibleset" data-theme="a" data-content-theme="a">
            {{#each alarms}}
            <div data-role="collapsible">
                <h3>Alarm #{{math @index "+" 1}}</h3>
                <div class="ui-field-contain">
                    <label for="alarm_{{@index}}_title">Title:</label>
                    <input type="text" name="alarm_{{@index}}_title" id="alarm_{{@index}}_title" />
                </div>
                <div class="ui-field-contain">
                    <label for="alarm_{{@index}}_time">Time:</label>
                    <input type="date" data-role="datebox" name="alarm_{{@index}}_time" id="alarm_{{@index}}_time" data-options='{"mode": "timebox"}' />
                </div>
                <fieldset data-role="controlgroup" data-type="horizontal" class="ui-field-contain">
                    <legend>Days</legend>
                    <input type="checkbox" name="alarm_{{@index}}_days" id="alarm_{{@index}}_days_mon" value="mon" />
                    <label for="alarm_{{@index}}_days_mon">Mon</label>

                    <input type="checkbox" name="alarm_{{@index}}_days" id="alarm_{{@index}}_days_tue" value="tue" />
                    <label for="alarm_{{@index}}_days_tue">Tue</label>

                    <input type="checkbox" name="alarm_{{@index}}_days" id="alarm_{{@index}}_days_wed" value="wed" />
                    <label for="alarm_{{@index}}_days_wed">Wed</label>

                    <input type="checkbox" name="alarm_{{@index}}_days" id="alarm_{{@index}}_days_thu" value="thu" />
                    <label for="alarm_{{@index}}_days_thu">Thu</label>

                    <input type="checkbox" name="alarm_{{@index}}_days" id="alarm_{{@index}}_days_fri" value="fri" />
                    <label for="alarm_{{@index}}_days_fri">Fri</label>

                    <input type="checkbox" name="alarm_{{@index}}_days" id="alarm_{{@index}}_days_sat" value="sat" />
                    <label for="alarm_{{@index}}_days_sat">Sat</label>

                    <input type="checkbox" name="alarm_{{@index}}_days" id="alarm_{{@index}}_days_sun" value="sun" />
                    <label for="alarm_{{@index}}_days_sun">Sun</label>
                </fieldset>
            </div>
            {{/each}}
        </div>
        <h2>Internet Radio</h2>
        <div class="ui-field-contain">
            <label for="radio_custom_stations">Custom Stations (Stream URI)</label>
            <textarea name="radio_custom_stations" 
                      id="radio_custom_stations" 
                      style="font-family: monospace; overflow: scroll; white-space: pre;" 
                      placeholder="Stream URIs (one on each line)"
                      rows="{{math radio_stations.length '+' 2}}">
{{#each radio_stations}}
{{stream_uri}}
{{/each}}
</textarea>
        </div>
        <button type="submit" value="Submit">Submit</button>
</script>
    <script type="text/javascript" src="js/handlebars-v4.0.2.js"></script>
    <script>
        Handlebars.registerHelper("math", function (lvalue, operator, rvalue, options) {
            lvalue = parseFloat(lvalue);
            rvalue = parseFloat(rvalue);

            return {
                "+": lvalue + rvalue,
                "-": lvalue - rvalue,
                "*": lvalue * rvalue,
                "/": lvalue / rvalue,
                "%": lvalue % rvalue
            }[operator];
        });
    </script>
</head>
<body>
    <div data-role="page">
        <div data-role="header">
            <h1>Digital Nightstand Frontend</h1>
            <div data-role="navbar" data-grid="a">
                <ul>
                    <li><a href="index.html" class="ui-btn ui-btn-active ui-state-persist ui-icon-prev">Setup</a></li>
                    <li><a href="player.html" class="ui-btn ui-icon-prev" data-ajax="false">Radio Player</a></li>
                </ul>
            </div><!-- /navbar -->
        </div><!-- /header -->

        <div role="main" class="ui-content">
            <form method="post" id="form"></form>
        </div><!-- /content -->
    </div><!-- /page -->
    <script>
        $(document).ready(function () {
            var context = {
                alarms: [{
                    // #1
                }, {
                    // #2
                }, {
                    // #3
                }, {
                    // #4
                }, {
                    // #5
                }],
                radio_stations: []
            };
            var num_alarms = context.alarms.length;
            var source = $("#entry-template").html();
            var template = Handlebars.compile(source);
            var html = template(context);
            $("#form").html(html).trigger("create");
            $("#form").on("submit", function (e) {
                e.preventDefault();
                var alarms = [];
                for (var i = 0; i < num_alarms; i++) {
                    var $time = $("#alarm_" + i + "_time");
                    var $hour = $("#alarm_" + i + "_hour");
                    var $min = $("#alarm_" + i + "_min");
                    var $title = $("#alarm_" + i + "_title");
                    var $days = $("input[name='alarm_" + i + "_days']:checked");

                    if ($time.val()) {
                        var time = $time.val().split(":");
                        var hour = parseInt(time[0], 10);
                        var min = parseInt(time[1], 10);
                        var obj = {
                            time: [hour, min],
                            //time: [+$hour.val(), +$min.val()],
                            title: $title.val() || "ALARM",
                        };
                        if ($days.length > 0) {
                            obj.days = [];
                            $days.each(function (index) {
                                obj.days[index] = $(this).val();
                            });
                        }
                        alarms.push(obj);
                    }
                }

                console.log(alarms);

                $.post("/", JSON.stringify({
                    alarms: alarms,
                    radio_stations: $("#radio_custom_stations").val().trim().split("\n").map(function (line, index) {
                        return {
                            name: "Custom #" + (index + 1),
                            groups: [ "Custom" ],
                            stream_uri: line + ""
                        }
                    })
                }));

            });
        });
    </script>
</body>
</html>